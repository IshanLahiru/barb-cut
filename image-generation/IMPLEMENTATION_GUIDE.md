# Prompt & Results Implementation Guide

## Quick Start for Using the Prompt-to-Image System

### Installation

```bash
npm install
```

### 1. Creating Prompts

Create a new prompt with your text instructions:

```javascript
const GenerationSystem = require('./generation-system');
const system = new GenerationSystem();

await system.generateFromPrompt({
  promptName: 'Modern Haircut',
  mainPrompt: 'A professional portrait of a man with a modern undercut, perfect lighting...',
  negativePrompt: 'blurry, low quality, distorted',
  style: 'portrait',
  category: 'haircut',
  tags: ['portrait', 'professional', 'modern'],
  parameters: {
    seed: Math.random() * 1000000,
    steps: 25,
    cfg: 8.0,
  }
});
```

**What Gets Saved:**
- ✅ Full prompt text in JSON
- ✅ Negative prompt for quality control
- ✅ Instructions for specific nodes
- ✅ All parameters used
- ✅ Timestamp and metadata

**File Location:** `data/prompts/{promptId}.json`

### 2. Modifying Prompts

All changes are versioned automatically:

```javascript
const prompt = await system.getPrompt(promptId);

// Update the prompt
await system.updatePrompt(promptId, {
  mainPrompt: 'Updated text with more details...',
  negativePrompt: 'Updated negative prompts...',
});
```

**What Happens:**
- ✅ New version created
- ✅ Old versions preserved
- ✅ Can compare results from different versions
- ✅ Full change history maintained

### 3. Viewing Results

See all generated images for a prompt:

```javascript
const comparison = await system.compareResults(promptId);

console.log(`Master Image: ${comparison.masterImage ? 'Set' : 'Not set'}`);
console.log(`Total Results: ${comparison.totalResults}`);

// List all results
comparison.results.forEach(result => {
  console.log(`Result: ${result.id}`);
  console.log(`  Execution Time: ${result.executionTime}ms`);
  console.log(`  Images: ${result.images.length}`);
  console.log(`  Master: ${result.isMaster ? 'Yes ⭐' : 'No'}`);
});
```

### 4. Setting Master Image

Choose the best image as reference:

```javascript
// Set first image of a result as master
await system.setMaster(promptId, resultId, 0);

// View master image
const master = await system.getMaster(promptId);
console.log(`Master: ${master.image.filename}`);
```

## JSON Data Structure

### Prompt JSON
```json
{
  "id": "prompt_abc123_xyz",
  "name": "Modern Haircut",
  "mainPrompt": "A professional portrait...",
  "negativePrompt": "blurry, low quality...",
  "style": "portrait",
  "category": "haircut",
  "tags": ["portrait", "professional"],
  "versions": [
    { "version": 1, "mainPrompt": "...", "createdAt": "..." },
    { "version": 2, "mainPrompt": "...", "createdAt": "..." }
  ]
}
```

**File:** `data/prompts/{promptId}.json`

### Result JSON
```json
{
  "id": "result_def456_uvw",
  "promptId": "prompt_abc123_xyz",
  "workflowId": "workflow_xyz123_abc",
  "images": [
    {
      "filename": "generated_image_001.png",
      "path": "/path/to/image.png",
      "size": "2.38 MB",
      "bytes": 2500000
    }
  ],
  "executionTime": 45000,
  "metadata": {
    "steps": 25,
    "cfg": 8.0,
    "seed": 567890,
    "generatedAt": "2026-02-19T10:35:45Z"
  }
}
```

**File:** `data/results/{resultId}.json`

### Master Image JSON
```json
{
  "id": "master_ghi789_jkl",
  "promptId": "prompt_abc123_xyz",
  "resultId": "result_def456_uvw",
  "imageIndex": 0,
  "image": {
    "filename": "generated_image_001.png",
    "path": "/path/to/image.png"
  },
  "metadata": {
    "selectedAsMaster": "2026-02-19T10:45:00Z"
  }
}
```

**File:** `data/results/master-images/{promptId}_master.json`

## Directory Structure

```
data/
├── prompts/                          # Prompt definitions
│   └── prompt_abc123_xyz.json
│
├── workflows/
│   ├── templates/                   # Workflow templates
│   │   └── default_portrait.json
│   └── generated/                   # Generated workflows
│       └── workflow_def456_uvw.json
│
└── results/
    ├── result_def456_uvw.json       # Generation results
    ├── galleries/                   # Gallery collections
    │   └── gallery_stu345_vwx.json
    └── master-images/               # Master image references
        └── prompt_abc123_xyz_master.json
```

## Workflow

### 1. Create Prompt
```
You enter:  "A professional portrait with..."
         ↓
System saves: prompt_abc123_xyz.json
         ↓
Returns: promptId "prompt_abc123_xyz"
```

### 2. Generate Image
```
promptId + workflow template
         ↓
System generates: workflow_def456_uvw.json
         ↓
Submits to ComfyUI
         ↓
Returns: ComfyUI promptId
```

### 3. Track Result
```
Image generated by ComfyUI
         ↓
System saves: result_def456_uvw.json
         ↓
Includes: image files, metadata, timing
```

### 4. Set Master
```
You select best result
         ↓
System saves: prompt_abc123_xyz_master.json
         ↓
Creates reference for comparison
```

## API Methods

### Create & Modify Prompts
```javascript
// Create new prompt
const prompt = await system.generateFromPrompt({
  promptName: 'Name',
  mainPrompt: 'Your text here...',
  negativePrompt: 'What to avoid...',
  style: 'portrait',
  category: 'haircut',
  tags: ['tag1', 'tag2'],
  parameters: { seed: 123, steps: 25, cfg: 8.0 }
});

// Get a prompt
const prompt = await system.getPrompt(promptId);

// Update prompt (creates new version)
const updated = await system.updatePrompt(promptId, {
  mainPrompt: 'Updated text...',
  negativePrompt: 'Updated avoidance...'
});

// List all prompts
const prompts = await system.listPrompts({ category: 'haircut' });
```

### Work with Results
```javascript
// Get comparison view
const comparison = await system.compareResults(promptId, limit = 20);

// Set master image
const master = await system.setMaster(promptId, resultId, imageIndex = 0);

// Get master image
const master = await system.getMaster(promptId);

// View gallery as HTML
const html = await system.viewGallery(promptId);

// Export everything
const exported = await system.exportAll(promptId);
```

## Real-World Example

```javascript
const system = new GenerationSystem();

// Step 1: Create a prompt
const result1 = await system.generateFromPrompt({
  promptName: 'Undercut Haircut',
  mainPrompt: 'Professional portrait with modern undercut, clean lines',
  negativePrompt: 'blurry, bad lighting',
  parameters: { steps: 25, cfg: 8.0 }
});

const promptId = result1.prompt.id;
console.log(`Created prompt: ${promptId}`);

// Step 2: Wait for generation (in real scenario)
// ... ComfyUI generates image ...

// Step 3: View all results
const comparison = await system.compareResults(promptId);
console.log(`${comparison.totalResults} results generated`);

// Step 4: Select best one
const bestResult = comparison.results[0];
await system.setMaster(promptId, bestResult.id, 0);
console.log(`Selected master image`);

// Step 5: Update prompt for next iteration
await system.updatePrompt(promptId, {
  mainPrompt: 'Even better prompt...'
});

// Step 6: Generate more with new version
const result2 = await system.generateFromPrompt({
  promptName: 'Undercut Haircut v2',
  mainPrompt: 'Even better prompt...',
  negativePrompt: 'blurry, bad lighting'
});

// Step 7: Compare all versions
const comparison2 = await system.compareResults(promptId);
console.log(`${comparison2.totalResults} total results`);
console.log(`Master: ${comparison2.masterImage.image.filename}`);

// Step 8: Export for archival
const exported = await system.exportAll(promptId);
// Successfully created: exported JSON with all data
```

## Benefits

✅ **Full History**: See every prompt version and result  
✅ **Easy Comparison**: Side-by-side view of different attempts  
✅ **Master Selection**: Pin the best image for reference  
✅ **JSON Storage**: Human-readable, version-control friendly  
✅ **Complete Metadata**: Know exactly how each image was generated  
✅ **Easy Export**: Archive everything as JSON  
✅ **Change Tracking**: See how each modification affects results  

## Where Data Is Stored

| What | Where | Format |
|------|-------|--------|
| Prompts | `data/prompts/*.json` | JSON with versions |
| Workflows | `data/workflows/generated/*.json` | JSON |
| Results | `data/results/*.json` | JSON metadata + image files |
| Master Images | `data/results/master-images/*.json` | JSON reference |
| Galleries | `data/results/galleries/*.json` | JSON collection |

All JSON files are human-readable and easy to modify manually if needed.

## Next Steps

1. **Run Examples**
   ```bash
   npm run example:simple-usage
   npm run example:prompt-gallery
   npm run example:complete-workflow
   ```

2. **Create Your First Prompt**
   - Use the simple system
   - See JSON files created
   - Modify prompts and watch versioning

3. **Generate Images**
   - Submit to ComfyUI
   - Track results
   - Select best ones

4. **Build Gallery**
   - Compare all results
   - See version differences
   - Export complete datasets
